<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Recherche AIFM</title>

<style>
/* =============================
   FOND GLOBAL
   ============================= */
html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
}

body {
  font-family: Arial, sans-serif;

  background-image: url("2926385d5f7560d3.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

/* Voile blanc pour lisibilit√© */
.background-overlay {
  min-height: 100vh;
  background: rgba(255, 255, 255, 0.92);
  padding: 30px;
}

/* =============================
   LOGO PwC
   ============================= */
.logo-container {
  position: fixed;
  top: 20px;
  right: 30px;
  z-index: 1000;
}

.logo-container img {
  height: 55px;
}

/* =============================
   CONTAINER PRINCIPAL
   ============================= */
.app-container {
  width: 100%;
  max-width: 95vw;
  margin: auto;
}

/* =============================
   UI
   ============================= */
input, select, button {
  padding: 8px;
  margin-right: 10px;
  margin-bottom: 10px;
}

button {
  cursor: pointer;
}

#exportBtn {
  background-color: #f05a28;
  color: white;
  border: none;
  border-radius: 4px;
}

#exportBtn:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

/* =============================
   TABLEAU + SCROLL HORIZONTAL
   ============================= */
.table-wrapper {
  margin-top: 20px;
  overflow-x: auto;
  background: white;
  border: 1px solid #ccc;
}

table {
  border-collapse: collapse;
  min-width: 1600px; /* force le scroll */
  width: 100%;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: left;
  white-space: nowrap;
}

th {
  background: #f0f0f0;
}

/* =============================
   PAGINATION / STATUS
   ============================= */
#status {
  margin-top: 10px;
  font-style: italic;
}

.pagination {
  margin-top: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}
</style>
</head>

<body>

<!-- Logo -->
<div class="logo-container">
  <img src="PwC_2025_Logo.svg.png" alt="PwC">
</div>

<div class="background-overlay">
<div class="app-container">

<h2>Recherche AIFM</h2>

<input type="text" id="q" placeholder="Texte √† rechercher">

<select id="field">
  <option value="AIFM_NAME">Gestionnaire (AIFM)</option>
  <option value="AIF_NAME">Fonds (AIF)</option>
  <option value="AIF_SUBFUND_NAME">Sous-fonds</option>
</select>

<input type="date" id="date">

<button onclick="search()">OK</button>
<button id="exportBtn" onclick="exportToExcel()" disabled>üìä Export Excel</button>

<div id="paginationTop" class="pagination" style="display:none;">
  <button onclick="prevPage()">‚¨Ö Pr√©c√©dent</button>
  <span id="pageInfoTop"></span>
  <button onclick="nextPage()">Suivant ‚û°</button>
</div>

<div id="status"></div>

<div class="table-wrapper">
<table id="results" style="display:none;">
<thead>
<tr>
  <th>A</th>
  <th>NNNNNNNN</th>
  <th>AIFM_NAME</th>
  <th>STATUS</th>
  <th>F</th>
  <th>MMMMMMMM</th>
  <th>AIF_NAME</th>
  <th>CCCCCCCC</th>
  <th>AIF_SUBFUND_NAME</th>
  <th>STARTING_MANAGEMENT_DATE_OF_THE_AIF</th>
  <th>ENDING_MANAGEMENT_DATE_OF_THE_AIF</th>
  <th>REGISTRATION_DATE_OR_INCEPTION_DATE_OF_THE_SUBFUND_OR_AIF</th>
  <th>CLOSING_DATE_OF_THE_SUBFUND_OR_AIF</th>
  <th>IMPORT_DATE</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="paginationBottom" class="pagination" style="display:none;">
  <button onclick="prevPage()">‚¨Ö Pr√©c√©dent</button>
  <span id="pageInfoBottom"></span>
  <button onclick="nextPage()">Suivant ‚û°</button>
</div>

</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let currentPage = 1;
const pageSize = 100;
let currentResults = [];
let totalPages = 0;
let isCalculatingTotal = false;

// üîê Cl√© API (POC / test)
const API_KEY = "PWCLUXEMBOURG2026";

// üåê URL API
const API_BASE_URL = "https://roman-thereby-requesting-teddy.trycloudflare.com/webhook/aifm/search";

// üîé Recherche
async function search(resetPage = true) {
  if (resetPage) {
    currentPage = 1;
    totalPages = 0;

    // Calculer le total en arri√®re-plan
    if (!isCalculatingTotal) {
      calculateTotalPages();
    }
  }

  const q = document.getElementById("q").value.trim();
  const field = document.getElementById("field").value;
  const date = document.getElementById("date").value;

  let url = API_BASE_URL;
  const params = [];

  params.push("key=" + encodeURIComponent(API_KEY));
  if (q) params.push("q=" + encodeURIComponent(q));
  if (field) params.push("field=" + encodeURIComponent(field));
  if (date) params.push("date=" + encodeURIComponent(date));
  params.push("page=" + currentPage);
  params.push("pageSize=" + pageSize);

  url += "?" + params.join("&");

  const status = document.getElementById("status");
  const table = document.getElementById("results");
  const tbody = document.querySelector("#results tbody");
  const exportBtn = document.getElementById("exportBtn");
  const paginationTop = document.getElementById("paginationTop");
  const paginationBottom = document.getElementById("paginationBottom");

  status.innerText = "Recherche en cours...";
  table.style.display = "none";
  paginationTop.style.display = "none";
  paginationBottom.style.display = "none";
  tbody.innerHTML = "";
  exportBtn.disabled = true;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (!Array.isArray(data) || data.length === 0) {
      status.innerText = "Aucun r√©sultat trouv√©.";
      currentResults = [];
      exportBtn.disabled = true;
      return;
    }

    currentResults = data;

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.a || ""}</td>
        <td>${row.nnnnnnnn || ""}</td>
        <td>${row.aifm_name || ""}</td>
        <td>${row.status || ""}</td>
        <td>${row.f || ""}</td>
        <td>${row.mmmmmmmm || ""}</td>
        <td>${row.aif_name || ""}</td>
        <td>${row.cccccccc || ""}</td>
        <td>${row.aif_subfund_name || ""}</td>
        <td>${row.starting_management_date_of_the_aif || ""}</td>
        <td>${row.ending_management_date_of_the_aif || ""}</td>
        <td>${row.registration_date_or_inception_date_of_the_subfund_or_aif || ""}</td>
        <td>${row.closing_date_of_the_subfund_or_aif || ""}</td>
        <td>${row.import_date || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    table.style.display = "table";
    paginationTop.style.display = "flex";
    paginationBottom.style.display = "flex";
    exportBtn.disabled = false;

    updatePaginationInfo();
    status.innerText = data.length + " r√©sultat(s) sur cette page";

  } catch (e) {
    status.innerText = "Erreur lors de la recherche (API indisponible ?)";
    currentResults = [];
    exportBtn.disabled = true;
  }
}

// Calculer le nombre total de pages en arri√®re-plan
async function calculateTotalPages() {
  isCalculatingTotal = true;

  const q = document.getElementById("q").value.trim();
  const field = document.getElementById("field").value;
  const date = document.getElementById("date").value;

  let page = 1;
  let totalCount = 0;

  while (true) {
    let url = API_BASE_URL;
    const params = [];

    params.push("key=" + encodeURIComponent(API_KEY));
    if (q) params.push("q=" + encodeURIComponent(q));
    if (field) params.push("field=" + encodeURIComponent(field));
    if (date) params.push("date=" + encodeURIComponent(date));
    params.push("page=" + page);
    params.push("pageSize=" + pageSize);

    url += "?" + params.join("&");

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        break;
      }

      totalCount += data.length;
      totalPages = Math.ceil(totalCount / pageSize);

      // Mettre √† jour l'affichage au fur et √† mesure
      updatePaginationInfo();

      if (data.length < pageSize) {
        break;
      }

      page++;
    } catch (e) {
      break;
    }
  }

  isCalculatingTotal = false;
}

// Mise √† jour de l'affichage de la pagination
function updatePaginationInfo() {
  let pageInfo;
  if (totalPages > 0) {
    pageInfo = `${currentPage}/${totalPages} - Total de pages : ${totalPages}`;
  } else {
    pageInfo = `Page ${currentPage} - Calcul du total en cours...`;
  }
  document.getElementById("pageInfoTop").innerText = pageInfo;
  document.getElementById("pageInfoBottom").innerText = pageInfo;
}

// Pagination
function nextPage() {
  currentPage++;
  search(false);
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    search(false);
  }
}

// üîë Entr√©e = lancer la recherche
document.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    search();
  }
});

// ‚úÖ üì• Export Excel (100 r√©sultats = page courante)
// IMPORTANT : aucune requ√™te r√©seau ici.
function exportToExcel() {
  if (!currentResults || currentResults.length === 0) {
    alert("Aucun r√©sultat √† exporter.");
    return;
  }

  const exportData = currentResults.map(row => ({
    "A": row.a || "",
    "NNNNNNNN": row.nnnnnnnn || "",
    "AIFM_NAME": row.aifm_name || "",
    "STATUS": row.status || "",
    "F": row.f || "",
    "MMMMMMMM": row.mmmmmmmm || "",
    "AIF_NAME": row.aif_name || "",
    "CCCCCCCC": row.cccccccc || "",
    "AIF_SUBFUND_NAME": row.aif_subfund_name || "",
    "STARTING_MANAGEMENT_DATE_OF_THE_AIF": row.starting_management_date_of_the_aif || "",
    "ENDING_MANAGEMENT_DATE_OF_THE_AIF": row.ending_management_date_of_the_aif || "",
    "REGISTRATION_DATE_OR_INCEPTION_DATE_OF_THE_SUBFUND_OR_AIF":
      row.registration_date_or_inception_date_of_the_subfund_or_aif || "",
    "CLOSING_DATE_OF_THE_SUBFUND_OR_AIF":
      row.closing_date_of_the_subfund_or_aif || "",
    "IMPORT_DATE": row.import_date || ""
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(wb, ws, "R√©sultats AIFM");

  const dateStr = new Date().toISOString().split("T")[0];
  XLSX.writeFile(wb, `AIFM_Recherche_${dateStr}_PAGE_${currentPage}.xlsx`);

  // Optionnel: informer l'utilisateur
  const status = document.getElementById("status");
  status.innerText = `Export effectu√© (page ${currentPage}, ${currentResults.length} ligne(s)).`;
}
</script>

</body>
</html>
