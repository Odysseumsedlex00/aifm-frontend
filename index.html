<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche AIFM</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    input, select, button {
      padding: 8px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    button {
      cursor: pointer;
    }

    #exportBtn {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
    }

    #exportBtn:hover {
      background-color: #218838;
    }

    #exportBtn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    #status {
      margin-top: 10px;
      font-style: italic;
    }

    .pagination {
      margin-top: 15px;
    }
  </style>
</head>
<body>

<h2>Recherche AIFM</h2>

<!-- Champ texte -->
<input type="text" id="q" placeholder="Texte √† rechercher">

<!-- Champ de recherche -->
<select id="field">
  <option value="AIFM_NAME">Gestionnaire (AIFM)</option>
  <option value="AIF_NAME">Fonds (AIF)</option>
  <option value="AIF_SUBFUND_NAME">Sous-fonds</option>
</select>

<!-- Date -->
<input type="date" id="date">

<!-- Boutons -->
<button onclick="search()">OK</button>
<button id="exportBtn" onclick="exportToExcel()" disabled>üìä Exporter en Excel</button>

<!-- Pagination HAUT -->
<div id="paginationTop" class="pagination" style="display:none;">
  <button onclick="prevPage()">‚¨Ö Pr√©c√©dent</button>
  <span id="pageInfoTop"></span>
  <button onclick="nextPage()">Suivant ‚û°</button>
</div>

<div id="status"></div>

<!-- Tableau r√©sultats -->
<table id="results" style="display:none;">
  <thead>
    <tr>
      <th>A</th>
      <th>NNNNNNNN</th>
      <th>AIFM_NAME</th>
      <th>STATUS</th>
      <th>F</th>
      <th>MMMMMMMM</th>
      <th>AIF_NAME</th>
      <th>CCCCCCCC</th>
      <th>AIF_SUBFUND_NAME</th>
      <th>STARTING_MANAGEMENT_DATE_OF_THE_AIF</th>
      <th>ENDING_MANAGEMENT_DATE_OF_THE_AIF</th>
      <th>REGISTRATION_DATE_OR_INCEPTION_DATE_OF_THE_SUBFUND_OR_AIF</th>
      <th>CLOSING_DATE_OF_THE_SUBFUND_OR_AIF</th>
      <th>IMPORT_DATE</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Pagination BAS -->
<div id="paginationBottom" class="pagination" style="display:none;">
  <button onclick="prevPage()">‚¨Ö Pr√©c√©dent</button>
  <span id="pageInfoBottom"></span>
  <button onclick="nextPage()">Suivant ‚û°</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let currentPage = 1;
const pageSize = 100;
let currentResults = [];

// üîê Cl√© API (POC / test)
const API_KEY = "PWCLUXEMBOURG2026";

// üåê URL API
const API_BASE_URL = "https://roman-thereby-requesting-teddy.trycloudflare.com/webhook/aifm/search";

// üîé Recherche
async function search(resetPage = true) {
  if (resetPage) currentPage = 1;

  const q = document.getElementById("q").value.trim();
  const field = document.getElementById("field").value;
  const date = document.getElementById("date").value;

  let url = API_BASE_URL;
  const params = [];

  params.push("key=" + encodeURIComponent(API_KEY));
  if (q) params.push("q=" + encodeURIComponent(q));
  if (field) params.push("field=" + encodeURIComponent(field));
  if (date) params.push("date=" + encodeURIComponent(date));
  params.push("page=" + currentPage);
  params.push("pageSize=" + pageSize);

  url += "?" + params.join("&");

  const status = document.getElementById("status");
  const table = document.getElementById("results");
  const tbody = document.querySelector("#results tbody");
  const exportBtn = document.getElementById("exportBtn");
  const paginationTop = document.getElementById("paginationTop");
  const paginationBottom = document.getElementById("paginationBottom");

  status.innerText = "Recherche en cours...";
  table.style.display = "none";
  paginationTop.style.display = "none";
  paginationBottom.style.display = "none";
  tbody.innerHTML = "";
  exportBtn.disabled = true;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (!Array.isArray(data) || data.length === 0) {
      status.innerText = "Aucun r√©sultat trouv√©.";
      return;
    }

    currentResults = data;

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.a || ""}</td>
        <td>${row.nnnnnnnn || ""}</td>
        <td>${row.aifm_name || ""}</td>
        <td>${row.status || ""}</td>
        <td>${row.f || ""}</td>
        <td>${row.mmmmmmmm || ""}</td>
        <td>${row.aif_name || ""}</td>
        <td>${row.cccccccc || ""}</td>
        <td>${row.aif_subfund_name || ""}</td>
        <td>${row.starting_management_date_of_the_aif || ""}</td>
        <td>${row.ending_management_date_of_the_aif || ""}</td>
        <td>${row.registration_date_or_inception_date_of_the_subfund_or_aif || ""}</td>
        <td>${row.closing_date_of_the_subfund_or_aif || ""}</td>
        <td>${row.import_date || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    table.style.display = "table";
    paginationTop.style.display = "block";
    paginationBottom.style.display = "block";
    exportBtn.disabled = false;

    document.getElementById("pageInfoTop").innerText = "Page " + currentPage;
    document.getElementById("pageInfoBottom").innerText = "Page " + currentPage;
    status.innerText = data.length + " r√©sultat(s)";

  } catch (e) {
    status.innerText = "Erreur lors de la recherche (API indisponible ?)";
  }
}

// Pagination
function nextPage() {
  currentPage++;
  search(false);
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    search(false);
  }
}

// üîë Entr√©e = lancer la recherche
document.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    search();
  }
});

// üì• Export Excel
async function fetchAllResults() {
  let allResults = [];
  let page = 1;
  let hasMore = true;

  const q = document.getElementById("q").value.trim();
  const field = document.getElementById("field").value;
  const date = document.getElementById("date").value;

  const status = document.getElementById("status");
  status.innerText = "R√©cup√©ration de tous les r√©sultats...";

  while (hasMore) {
    let url = API_BASE_URL;
    const params = [];

    params.push("key=" + encodeURIComponent(API_KEY));
    if (q) params.push("q=" + encodeURIComponent(q));
    if (field) params.push("field=" + encodeURIComponent(field));
    if (date) params.push("date=" + encodeURIComponent(date));
    params.push("page=" + page);
    params.push("pageSize=" + pageSize);

    url += "?" + params.join("&");

    const response = await fetch(url);
    const data = await response.json();

    if (!Array.isArray(data) || data.length === 0) {
      hasMore = false;
    } else {
      allResults = allResults.concat(data);
      page++;
    }
  }

  return allResults;
}

async function exportToExcel() {
  const allResults = await fetchAllResults();

  if (allResults.length === 0) {
    alert("Aucun r√©sultat √† exporter.");
    return;
  }

  const exportData = allResults.map(row => ({
    "A": row.a || "",
    "NNNNNNNN": row.nnnnnnnn || "",
    "AIFM_NAME": row.aifm_name || "",
    "STATUS": row.status || "",
    "F": row.f || "",
    "MMMMMMMM": row.mmmmmmmm || "",
    "AIF_NAME": row.aif_name || "",
    "CCCCCCCC": row.cccccccc || "",
    "AIF_SUBFUND_NAME": row.aif_subfund_name || "",
    "STARTING_MANAGEMENT_DATE_OF_THE_AIF": row.starting_management_date_of_the_aif || "",
    "ENDING_MANAGEMENT_DATE_OF_THE_AIF": row.ending_management_date_of_the_aif || "",
    "REGISTRATION_DATE_OR_INCEPTION_DATE_OF_THE_SUBFUND_OR_AIF": row.registration_date_or_inception_date_of_the_subfund_or_aif || "",
    "CLOSING_DATE_OF_THE_SUBFUND_OR_AIF": row.closing_date_of_the_subfund_or_aif || "",
    "IMPORT_DATE": row.import_date || ""
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(wb, ws, "R√©sultats AIFM");

  const date = new Date().toISOString().split("T")[0];
  XLSX.writeFile(wb, `AIFM_Recherche_${date}_TOUS.xlsx`);
}
</script>

</body>
</html>
